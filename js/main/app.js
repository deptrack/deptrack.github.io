define(["require", "exports", "jquery", "./model/ProjectModel", "./view/DependencyListView", "./view/LayoutView", "./view/NewsfeedView", "./collection/NewsfeedCollection"], function (require, exports, $, ProjectModel_1, DependencyListView_1, LayoutView_1, NewsfeedView_1, NewsfeedCollection_1) {
    window["NPM_URL"] = "https://cors-anywhere.herokuapp.com/https://registry.npmjs.org";
    window["GITHUB_URL"] = "https://api.github.com";
    function initAppForPackageJsonUrl(url) {
        $.getJSON(url, initAppForPackageJson);
    }
    function initAppForPackageJson(packageJson) {
        if (_paq) {
            _paq.push(['trackEvent', 'User', 'LandingAnalyseDep']);
        }
        ProjectModel_1.default.createForPackageJson(packageJson).then(function (project) {
            var linkTags = document.getElementsByTagName("link");
            for (var i in linkTags) {
                var tag = linkTags[i];
                if ($(tag).attr("href") == "css/landing/grayscale.css") {
                    $(tag).remove();
                    break;
                }
            }
            var layout = new LayoutView_1.default(document.getElementsByTagName("body")[0]);
            layout.render();
            var depList = new DependencyListView_1.default(project);
            layout.setLeftPane(depList.render());
            NewsfeedCollection_1.default.createFor(project.dependencies.toArray())
                .then(function (newsfeed) { return new NewsfeedView_1.default(newsfeed); })
                .then(function (view) { return layout.setCenterPane(view.render()); });
        });
    }
    function onSelected(e) {
        initAppForPackageJsonUrl(e.target.value);
    }
    function normalizePackageJsonUrl(inputUrl) {
        var pathname = null;
        if (inputUrl.indexOf("git@github.com") === 0) {
            pathname = "/" + inputUrl.substring(inputUrl.indexOf(":") + 1, inputUrl.length - 4);
        }
        else {
            if (inputUrl.indexOf("://") == -1) {
                return null;
            }
            var parser = document.createElement('a');
            parser.href = inputUrl;
            pathname = parser.pathname;
            if (parser.host === "raw.githubusercontent.com") {
                return inputUrl;
            }
            if (parser.host === "github.com") {
                var pathSegments = pathname.split("/");
                if (pathSegments.length >= 4 && pathSegments[3] == "blob") {
                    pathname = "/" + pathSegments[1] + "/" + pathSegments[2];
                }
            }
        }
        if (pathname.substring(pathname.length - 4) === ".git") {
            pathname = pathname.substring(0, pathname.length - 4);
        }
        if (pathname.charAt(pathname.length - 1) == "/") {
            pathname = pathname.substring(0, pathname.length - 1);
        }
        if (pathname == null) {
            return null;
        }
        return "https://raw.githubusercontent.com" + pathname + "/master/package.json";
    }
    function error(msg) {
        if (_paq) {
            _paq.push(['trackEvent', 'User', 'LandingAnalyseDepFail']);
        }
        $("#lbl-empty").show().html(msg);
    }
    function isValidPackageJson(rawPackageJson) {
        var packageJson;
        try {
            packageJson = JSON.parse(rawPackageJson);
        }
        catch (e) {
            error("Syntax error: this is not a valid package.json file");
            return null;
        }
        if (!(packageJson.name && packageJson.version)) {
            error("Please provide a package.json with a name and a version");
            return null;
        }
        var hasDeps = _.isObject(packageJson.dependencies) && !_.isEmpty(packageJson.dependencies);
        var hasDevDeps = _.isObject(packageJson.devDependencies) && !_.isEmpty(packageJson.devDependencies);
        if (!(hasDeps || hasDevDeps)) {
            error("Please provide a package.json with at least one dependency");
            return null;
        }
        return packageJson;
    }
    function onBtnDepsClick() {
        var $txtRepoUrl = $("#txt-repo-url");
        var $txtPackageJson = $("#txt-package-json");
        var repoUrl = $txtRepoUrl.val().trim();
        var packageJson = $txtPackageJson.val().trim();
        if (!repoUrl && !packageJson) {
            error("Please specify your package.json");
        }
        else if (packageJson) {
            var validPackageJson = isValidPackageJson(packageJson);
            if (validPackageJson !== null) {
                initAppForPackageJson(validPackageJson);
            }
        }
        else {
            var realUrl = normalizePackageJsonUrl(repoUrl);
            if (realUrl === null) {
                error("could not determine the URL of the package.json file");
            }
            else {
                initAppForPackageJsonUrl(realUrl);
            }
        }
    }
    function app() {
        $("#sel-project-url").change(onSelected);
        $("#btn-deps").click(onBtnDepsClick);
    }
    return app;
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4vYXBwLnRzIl0sIm5hbWVzIjpbImluaXRBcHBGb3JQYWNrYWdlSnNvblVybCIsImluaXRBcHBGb3JQYWNrYWdlSnNvbiIsIm9uU2VsZWN0ZWQiLCJub3JtYWxpemVQYWNrYWdlSnNvblVybCIsImVycm9yIiwiaXNWYWxpZFBhY2thZ2VKc29uIiwib25CdG5EZXBzQ2xpY2siLCJhcHAiXSwibWFwcGluZ3MiOiI7SUFPQSxNQUFNLENBQUMsU0FBUyxDQUFDLEdBQUcsZ0VBQWdFLENBQUM7SUFDckYsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLHdCQUF3QixDQUFDO0lBR2hELGtDQUFrQyxHQUFXO1FBQzNDQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxFQUFFQSxxQkFBcUJBLENBQUNBLENBQUNBO0lBQ3hDQSxDQUFDQTtJQUVELCtCQUErQixXQUFnQjtRQUM3Q0MsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDVEEsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsWUFBWUEsRUFBRUEsTUFBTUEsRUFBRUEsbUJBQW1CQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN6REEsQ0FBQ0E7UUFDREEsc0JBQVlBLENBQUNBLG9CQUFvQkEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FDakRBLFVBQUNBLE9BQU9BO1lBQ05BLElBQUlBLFFBQVFBLEdBQUdBLFFBQVFBLENBQUNBLG9CQUFvQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFDckRBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO2dCQUN2QkEsSUFBTUEsR0FBR0EsR0FBR0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3hCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFD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QUFDQSxDQUFDQSxJQUFJQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDMURBLFFBQVFBLEdBQUdBLEdBQUdBLEdBQUdBLFlBQVlBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLEdBQUdBLEdBQUdBLFlBQVlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUMzREEsQ0FBQ0E7WUFDSEEsQ0FBQ0E7UUFDSEEsQ0FBQ0E7UUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdkRBLFFBQVFBLEdBQUdBLFFBQVFBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLEVBQUVBLFFBQVFBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1FBQ3hEQSxDQUFDQTtRQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxRQUFRQSxDQUFDQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNoREEsUUFBUUEsR0FBR0EsUUFBUUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsUUFBUUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDeERBLENBQUNBO1FBQ0RBLEVBQUVBLENBQUNBLENBQUNBLFFBQVFBLElBQUlBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO1lBQ3JCQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtRQUNkQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxtQ0FBbUNBLEdBQUdBLFFBQVFBLEdBQUdBLHNCQUFzQkEsQ0FBQ0E7SUFDakZBLENBQUNBO0lBR0QsZUFBZSxHQUFXO1FBQ3hCQyxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNUQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxD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QUNBLENBQUNBO1lBQ2pEQSxFQUFFQSxDQUFDQSxDQUFDQSxPQUFPQSxLQUFLQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDckJBLEtBQUtBLENBQUNBLHNEQUFzREEsQ0FBQ0EsQ0FBQ0E7WUFDaEVBLENBQUNBO1lBQUNBLElBQUlBLENBQUNBLENBQUNBO2dCQUNOQSx3QkFBd0JBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1lBQ3BDQSxDQUFDQTtRQUNIQSxDQUFDQTtJQUNIQSxDQUFDQTtJQUdEO1FBQ0VDLENBQUNBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0E7UUFDekNBLENBQUNBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLGNBQWNBLENBQUNBLENBQUNBO0lBQ3ZDQSxDQUFDQTtJQUVELE9BQVMsR0FBRyxDQUFDIiwiZmlsZSI6Im1haW4vYXBwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICQgPSByZXF1aXJlKFwianF1ZXJ5XCIpO1xuaW1wb3J0IFByb2plY3RNb2RlbCBmcm9tIFwiLi9tb2RlbC9Qcm9qZWN0TW9kZWxcIjtcbmltcG9ydCBEZXBlbmRlbmN5TGlzdFZpZXcgZnJvbSBcIi4vdmlldy9EZXBlbmRlbmN5TGlzdFZpZXdcIjtcbmltcG9ydCBMYXlvdXRWaWV3IGZyb20gXCIuL3ZpZXcvTGF5b3V0Vmlld1wiO1xuaW1wb3J0IE5ld3NmZWVkVmlldyBmcm9tIFwiLi92aWV3L05ld3NmZWVkVmlld1wiO1xuaW1wb3J0IE5ld3NmZWVkQ29sbGVjdGlvbiBmcm9tIFwiLi9jb2xsZWN0aW9uL05ld3NmZWVkQ29sbGVjdGlvblwiO1xuXG53aW5kb3dbXCJOUE1fVVJMXCJdID0gXCJodHRwczovL2NvcnMtYW55d2hlcmUuaGVyb2t1YXBwLmNvbS9odHRwczovL3JlZ2lzdHJ5Lm5wbWpzLm9yZ1wiO1xud2luZG93W1wiR0lUSFVCX1VSTFwiXSA9IFwiaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbVwiO1xuZGVjbGFyZSB2YXIgX3BhcTogYW55W107XG5cbmZ1bmN0aW9uIGluaXRBcHBGb3JQYWNrYWdlSnNvblVybCh1cmw6IHN0cmluZykge1xuICAkLmdldEpTT04odXJsLCBpbml0QXBwRm9yUGFja2FnZUpzb24pO1xufVxuXG5mdW5jdGlvbiBpbml0QXBwRm9yUGFja2FnZUpzb24ocGFja2FnZUpzb246IGFueSkge1xuICBpZiAoX3BhcSkge1xuICAgIF9wYXEucHVzaChbJ3RyYWNrRXZlbnQnLCAnVXNlcicsICdMYW5kaW5nQW5hbHlzZURlcCddKTtcbiAgfVxuICBQcm9qZWN0TW9kZWwuY3JlYXRlRm9yUGFja2FnZUpzb24ocGFja2FnZUpzb24pLnRoZW4oXG4gICAgKHByb2plY3QpID0+IHtcbiAgICAgIHZhciBsaW5rVGFncyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwibGlua1wiKTtcbiAgICAgIGZvciAodmFyIGkgaW4gbGlua1RhZ3MpIHtcbiAgICAgICAgY29uc3QgdGFnID0gbGlua1RhZ3NbaV07XG4gICAgICAgIGlmICgkKHRhZykuYXR0cihcImhyZWZcIikgPT0gXCJjc3MvbGFuZGluZy9ncmF5c2NhbGUuY3NzXCIpIHtcbiAgICAgICAgICAkKHRhZykucmVtb3ZlKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgY29uc3QgbGF5b3V0ID0gbmV3IExheW91dFZpZXcoZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJib2R5XCIpWzBdKTtcbiAgICAgIGxheW91dC5yZW5kZXIoKTtcbiAgICAgIGNvbnN0IGRlcExpc3QgPSBuZXcgRGVwZW5kZW5jeUxpc3RWaWV3KHByb2plY3QpO1xuICAgICAgbGF5b3V0LnNldExlZnRQYW5lKGRlcExpc3QucmVuZGVyKCkpO1xuICAgICAgTmV3c2ZlZWRDb2xsZWN0aW9uLmNyZWF0ZUZvcihwcm9qZWN0LmRlcGVuZGVuY2llcy50b0FycmF5KCkpXG4gICAgICAgIC50aGVuKG5ld3NmZWVkID0+IG5ldyBOZXdzZmVlZFZpZXcobmV3c2ZlZWQpKVxuICAgICAgICAudGhlbih2aWV3ID0+IGxheW91dC5zZXRDZW50ZXJQYW5lKHZpZXcucmVuZGVyKCkpKTtcbiAgICB9XG4gICk7XG59XG5cbmZ1bmN0aW9uIG9uU2VsZWN0ZWQoZSkge1xuICBpbml0QXBwRm9yUGFja2FnZUpzb25VcmwoZS50YXJnZXQudmFsdWUpO1xufVxuXG5mdW5jdGlvbiBub3JtYWxpemVQYWNrYWdlSnNvblVybChpbnB1dFVybDogc3RyaW5nKTogc3RyaW5nIHtcbiAgdmFyIHBhdGhuYW1lID0gbnVsbDtcbiAgaWYgKGlucHV0VXJsLmluZGV4T2YoXCJnaXRAZ2l0aHViLmNvbVwiKSA9PT0gMCkge1xuICAgIHBhdGhuYW1lID0gXCIvXCIgKyBpbnB1dFVybC5zdWJzdHJpbmcoaW5wdXRVcmwuaW5kZXhPZihcIjpcIikgKyAxLCBpbnB1dFVybC5sZW5ndGggLSA0KTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoaW5wdXRVcmwuaW5kZXhPZihcIjovL1wiKSA9PSAtMSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIHZhciBwYXJzZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XG4gICAgcGFyc2VyLmhyZWYgPSBpbnB1dFVybDtcbiAgICBwYXRobmFtZSA9IHBhcnNlci5wYXRobmFtZTtcbiAgICBpZiAocGFyc2VyLmhvc3QgPT09IFwicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbVwiKSB7XG4gICAgICByZXR1cm4gaW5wdXRVcmw7XG4gICAgfVxuICAgIGlmIChwYXJzZXIuaG9zdCA9PT0gXCJnaXRodWIuY29tXCIpIHtcbiAgICAgIGNvbnN0IHBhdGhTZWdtZW50cyA9IHBhdGhuYW1lLnNwbGl0KFwiL1wiKTtcbiAgICAgIGlmIChwYXRoU2VnbWVudHMubGVuZ3RoID49IDQgJiYgcGF0aFNlZ21lbnRzWzNdID09IFwiYmxvYlwiKSB7XG4gICAgICAgIHBhdGhuYW1lID0gXCIvXCIgKyBwYXRoU2VnbWVudHNbMV0gKyBcIi9cIiArIHBhdGhTZWdtZW50c1syXTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgaWYgKHBhdGhuYW1lLnN1YnN0cmluZyhwYXRobmFtZS5sZW5ndGggLSA0KSA9PT0gXCIuZ2l0XCIpIHtcbiAgICBwYXRobmFtZSA9IHBhdGhuYW1lLnN1YnN0cmluZygwLCBwYXRobmFtZS5sZW5ndGggLSA0KTtcbiAgfVxuICBpZiAocGF0aG5hbWUuY2hhckF0KHBhdGhuYW1lLmxlbmd0aCAtIDEpID09IFwiL1wiKSB7XG4gICAgcGF0aG5hbWUgPSBwYXRobmFtZS5zdWJzdHJpbmcoMCwgcGF0aG5hbWUubGVuZ3RoIC0gMSk7XG4gIH1cbiAgaWYgKHBhdGhuYW1lID09IG51bGwpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICByZXR1cm4gXCJodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb21cIiArIHBhdGhuYW1lICsgXCIvbWFzdGVyL3BhY2thZ2UuanNvblwiO1xufVxuXG5cbmZ1bmN0aW9uIGVycm9yKG1zZzogc3RyaW5nKSB7XG4gIGlmIChfcGFxKSB7XG4gICAgX3BhcS5wdXNoKFsndHJhY2tFdmVudCcsICdVc2VyJywgJ0xhbmRpbmdBbmFseXNlRGVwRmFpbCddKTtcbiAgfVxuICAkKFwiI2xibC1lbXB0eVwiKS5zaG93KCkuaHRtbChtc2cpO1xufVxuXG5mdW5jdGlvbiBpc1ZhbGlkUGFja2FnZUpzb24ocmF3UGFja2FnZUpzb246IHN0cmluZyk6IGFueSB7XG4gIHZhciBwYWNrYWdlSnNvbjtcbiAgdHJ5IHtcbiAgICBwYWNrYWdlSnNvbiA9IEpTT04ucGFyc2UocmF3UGFja2FnZUpzb24pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgZXJyb3IoXCJTeW50YXggZXJyb3I6IHRoaXMgaXMgbm90IGEgdmFsaWQgcGFja2FnZS5qc29uIGZpbGVcIik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgaWYgKCEocGFja2FnZUpzb24ubmFtZSAmJiBwYWNrYWdlSnNvbi52ZXJzaW9uKSkge1xuICAgIGVycm9yKFwiUGxlYXNlIHByb3ZpZGUgYSBwYWNrYWdlLmpzb24gd2l0aCBhIG5hbWUgYW5kIGEgdmVyc2lvblwiKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuICBjb25zdCBoYXNEZXBzID0gXy5pc09iamVjdChwYWNrYWdlSnNvbi5kZXBlbmRlbmNpZXMpICYmICFfLmlzRW1wdHkocGFja2FnZUpzb24uZGVwZW5kZW5jaWVzKTtcbiAgY29uc3QgaGFzRGV2RGVwcyA9IF8uaXNPYmplY3QocGFja2FnZUpzb24uZGV2RGVwZW5kZW5jaWVzKSAmJiAhXy5pc0VtcHR5KHBhY2thZ2VKc29uLmRldkRlcGVuZGVuY2llcyk7XG4gIGlmICghKGhhc0RlcHMgfHwgaGFzRGV2RGVwcykpIHtcbiAgICBlcnJvcihcIlBsZWFzZSBwcm92aWRlIGEgcGFja2FnZS5qc29uIHdpdGggYXQgbGVhc3Qgb25lIGRlcGVuZGVuY3lcIik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgcmV0dXJuIHBhY2thZ2VKc29uO1xufVxuXG5mdW5jdGlvbiBvbkJ0bkRlcHNDbGljaygpIHtcbiAgY29uc3QgJHR4dFJlcG9VcmwgPSAkKFwiI3R4dC1yZXBvLXVybFwiKTtcbiAgY29uc3QgJHR4dFBhY2thZ2VKc29uID0gJChcIiN0eHQtcGFja2FnZS1qc29uXCIpO1xuICBjb25zdCByZXBvVXJsID0gJHR4dFJlcG9VcmwudmFsKCkudHJpbSgpO1xuICBjb25zdCBwYWNrYWdlSnNvbiA9ICR0eHRQYWNrYWdlSnNvbi52YWwoKS50cmltKCk7XG4gIGlmICghcmVwb1VybCAmJiAhcGFja2FnZUpzb24pIHtcbiAgICBlcnJvcihcIlBsZWFzZSBzcGVjaWZ5IHlvdXIgcGFja2FnZS5qc29uXCIpO1xuICB9IGVsc2UgaWYgKHBhY2thZ2VKc29uKSB7XG4gICAgY29uc3QgdmFsaWRQYWNrYWdlSnNvbiA9IGlzVmFsaWRQYWNrYWdlSnNvbihwYWNrYWdlSnNvbik7XG4gICAgaWYgKHZhbGlkUGFja2FnZUpzb24gIT09IG51bGwpIHtcbiAgICAgIGluaXRBcHBGb3JQYWNrYWdlSnNvbih2YWxpZFBhY2thZ2VKc29uKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgcmVhbFVybCA9IG5vcm1hbGl6ZVBhY2thZ2VKc29uVXJsKHJlcG9VcmwpO1xuICAgIGlmIChyZWFsVXJsID09PSBudWxsKSB7XG4gICAgICBlcnJvcihcImNvdWxkIG5vdCBkZXRlcm1pbmUgdGhlIFVSTCBvZiB0aGUgcGFja2FnZS5qc29uIGZpbGVcIik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGluaXRBcHBGb3JQYWNrYWdlSnNvblVybChyZWFsVXJsKTtcbiAgICB9XG4gIH1cbn1cblxuXG5mdW5jdGlvbiBhcHAoKSB7XG4gICQoXCIjc2VsLXByb2plY3QtdXJsXCIpLmNoYW5nZShvblNlbGVjdGVkKTtcbiAgJChcIiNidG4tZGVwc1wiKS5jbGljayhvbkJ0bkRlcHNDbGljayk7XG59XG5cbmV4cG9ydCA9IGFwcDtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
