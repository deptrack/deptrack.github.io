/// <amd-dependency path="promise" />
define(["require", "exports", "./ProgressIndicator", "promise"], function (require, exports, ProgressIndicator_1) {
    var PromiseCompletion = (function () {
        function PromiseCompletion(promises, progress) {
            var _this = this;
            if (progress === void 0) { progress = ProgressIndicator_1.NO_PROGRESS; }
            this.promises = promises;
            this.progress = progress;
            this.successResults = [];
            this.failureResults = [];
            this.mappers = [];
            this.failureHandlers = [];
            this.nextPromises = [];
            this.resolvers = [];
            this.rejectors = [];
            progress.setTotalStepCount(promises.length);
            _.each(promises, function (p) { return _this.installListeners(p); });
        }
        PromiseCompletion.waitFor = function (promises, progress) {
            if (progress === void 0) { progress = ProgressIndicator_1.NO_PROGRESS; }
            return new PromiseCompletion(promises, progress);
        };
        PromiseCompletion.prototype.installListeners = function (promise) {
            var _this = this;
            promise.then(function (result) {
                _this.progress.tick();
                _this.successResults.push(result);
                _this.checkIfThereIsPendingPromise();
            }).catch(function (f) {
                _this.progress.tick();
                _this.failureResults.push(f);
                _this.checkIfThereIsPendingPromise();
            });
        };
        PromiseCompletion.prototype.checkIfThereIsPendingPromise = function () {
            if (this.successResults.length + this.failureResults.length === this.promises.length) {
                this.triggerSuccesses();
                if (this.hasFailures()) {
                    this.triggerFailures();
                }
            }
        };
        PromiseCompletion.prototype.triggerFailures = function () {
            var _this = this;
            this.failureHandlers.forEach(function (handler) {
                handler(_this.failureResults);
            });
            this.rejectors.forEach(function (rejector) { return rejector(_this.failureResults); });
        };
        PromiseCompletion.prototype.triggerSuccesses = function () {
            var _this = this;
            this.mappers.forEach(function (mapper) {
                try {
                    var mapped = mapper(_this.successResults);
                    _.each(_this.resolvers, function (resolver) { return resolver(mapped); });
                }
                catch (e) {
                    _this.rejectors.forEach(function (rejector) { return rejector(e); });
                }
            });
        };
        PromiseCompletion.prototype.then = function (mapper) {
            var _this = this;
            this.mappers.push(mapper);
            var rval = new Promise(function (resolve, reject) {
                _this.resolvers.push(resolve);
                _this.rejectors.push(reject);
            });
            this.nextPromises.push(rval);
            this.checkIfThereIsPendingPromise();
            return rval;
        };
        PromiseCompletion.prototype.catch = function (onRejected) {
            this.failureHandlers.push(onRejected);
            return this;
        };
        PromiseCompletion.prototype.hasFailures = function () {
            return this.failureResults.length > 0;
        };
        return PromiseCompletion;
    })();
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = PromiseCompletion;
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4vbW9kZWwvUHJvbWlzZUNvbXBsZXRpb24udHMiXSwibmFtZXMiOlsiUHJvbWlzZUNvbXBsZXRpb24iLCJQcm9taXNlQ29tcGxldGlvbi5jb25zdHJ1Y3RvciIsIlByb21pc2VDb21wbGV0aW9uLndhaXRGb3IiLCJQcm9taXNlQ29tcGxldGlvbi5pbnN0YWxsTGlzdGVuZXJzIiwiUHJvbWlzZUNvbXBsZXRpb24uY2hlY2tJZlRoZXJlSXNQZW5kaW5nUHJvbWlzZSIsIlByb21pc2VDb21wbGV0aW9uLnRyaWdnZXJGYWlsdXJlcyIsIlByb21pc2VDb21wbGV0aW9uLnRyaWdnZXJTdWNjZXNzZXMiLCJQcm9taXNlQ29tcGxldGlvbi50aGVuIiwiUHJvbWlzZUNvbXBsZXRpb24uY2F0Y2giLCJQcm9taXNlQ29tcGxldGlvbi5oYXNGYWlsdXJlcyJdLCJtYXBwaW5ncyI6IkFBQUEscUNBQXFDOztJQVFyQztRQU9FQSwyQkFBb0JBLFFBQXFDQSxFQUN2Q0EsUUFBeUNBO1lBUjdEQyxpQkEwRkNBO1lBbEZXQSx3QkFBaURBLEdBQWpEQSwwQ0FBaURBO1lBRHZDQSxhQUFRQSxHQUFSQSxRQUFRQSxDQUE2QkE7WUFDdkNBLGFBQVFBLEdBQVJBLFFBQVFBLENBQWlDQTtZQUtuREEsbUJBQWNBLEdBQWFBLEVBQUVBLENBQUNBO1lBRTlCQSxtQkFBY0EsR0FBVUEsRUFBRUEsQ0FBQ0E7WUFFM0JBLFlBQU9BLEdBQTBCQSxFQUFFQSxDQUFDQTtZQUVwQ0Esb0JBQWVBLEdBQW9CQSxFQUFFQSxDQUFDQTtZQUV0Q0EsaUJBQVlBLEdBQTZCQSxFQUFFQSxDQUFDQTtZQUU1Q0EsY0FBU0EsR0FBeUJBLEVBQUVBLENBQUNBO1lBRXJDQSxjQUFTQSxHQUE4QkEsRUFBRUEsQ0FBQ0E7WUFoQmhEQSxRQUFRQSxDQUFDQSxpQkFBaUJBLENBQUNBLFFBQVFBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBQzVDQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxFQUFFQSxV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ZGVsL1Byb21pc2VDb21wbGV0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxhbWQtZGVwZW5kZW5jeSBwYXRoPVwicHJvbWlzZVwiIC8+XG5cblxuaW1wb3J0IElUaGVuYWJsZSA9IFByb21pc2UuSVRoZW5hYmxlO1xuaW1wb3J0IHtQcm9ncmVzc0luZGljYXRvciwgTk9fUFJPR1JFU1N9IGZyb20gXCIuL1Byb2dyZXNzSW5kaWNhdG9yXCI7XG50eXBlIEJhdGNoTWFwcGVyPFQsIFU+ID0gKGFyZzogQXJyYXk8VD4pID0+IFU7XG50eXBlIEVycm9ySGFuZGxlciA9IChlcnI6IGFueSkgPT4gdm9pZDtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUHJvbWlzZUNvbXBsZXRpb248VD4ge1xuXG4gIHB1YmxpYyBzdGF0aWMgd2FpdEZvcjxUPihwcm9taXNlczogQXJyYXk8UHJvbWlzZS5JVGhlbmFibGU8VD4+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3M6IFByb2dyZXNzSW5kaWNhdG9yID0gTk9fUFJPR1JFU1MpIDogUHJvbWlzZUNvbXBsZXRpb248VD4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZUNvbXBsZXRpb24ocHJvbWlzZXMsIHByb2dyZXNzKTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcHJvbWlzZXM6IEFycmF5PFByb21pc2UuSVRoZW5hYmxlPFQ+PixcbiAgICAgICAgICAgIHByaXZhdGUgcHJvZ3Jlc3M6IFByb2dyZXNzSW5kaWNhdG9yID0gTk9fUFJPR1JFU1MpIHtcbiAgICBwcm9ncmVzcy5zZXRUb3RhbFN0ZXBDb3VudChwcm9taXNlcy5sZW5ndGgpO1xuICAgIF8uZWFjaChwcm9taXNlcywgcCA9PiB0aGlzLmluc3RhbGxMaXN0ZW5lcnMocCkpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWNjZXNzUmVzdWx0czogQXJyYXk8VD4gPSBbXTtcblxuICBwcml2YXRlIGZhaWx1cmVSZXN1bHRzOiBhbnlbXSA9IFtdO1xuXG4gIHByaXZhdGUgbWFwcGVyczogQmF0Y2hNYXBwZXI8VCwgYW55PltdID0gW107XG5cbiAgcHJpdmF0ZSBmYWlsdXJlSGFuZGxlcnMgOiBFcnJvckhhbmRsZXJbXSA9IFtdO1xuXG4gIHByaXZhdGUgbmV4dFByb21pc2VzOiBQcm9taXNlLklUaGVuYWJsZTxhbnk+W10gPSBbXTtcblxuICBwcml2YXRlIHJlc29sdmVycyA6IEFycmF5PChhbnkpID0+IHZvaWQ+PSBbXTtcblxuICBwcml2YXRlIHJlamVjdG9yczogQXJyYXk8KGVycjogYW55KSA9PiB2b2lkPiA9IFtdO1xuXG4gIHByaXZhdGUgaW5zdGFsbExpc3RlbmVycyhwcm9taXNlOiBQcm9taXNlLklUaGVuYWJsZTxUPikge1xuICAgIHByb21pc2UudGhlbihyZXN1bHQgPT4ge1xuICAgICAgdGhpcy5wcm9ncmVzcy50aWNrKCk7XG4gICAgICB0aGlzLnN1Y2Nlc3NSZXN1bHRzLnB1c2gocmVzdWx0KTtcbiAgICAgIHRoaXMuY2hlY2tJZlRoZXJlSXNQZW5kaW5nUHJvbWlzZSgpO1xuICAgIH0pLmNhdGNoKGYgPT4ge1xuICAgICAgdGhpcy5wcm9ncmVzcy50aWNrKCk7XG4gICAgICB0aGlzLmZhaWx1cmVSZXN1bHRzLnB1c2goZik7XG4gICAgICB0aGlzLmNoZWNrSWZUaGVyZUlzUGVuZGluZ1Byb21pc2UoKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tJZlRoZXJlSXNQZW5kaW5nUHJvbWlzZSgpIHtcbiAgICBpZiAodGhpcy5zdWNjZXNzUmVzdWx0cy5sZW5ndGggKyB0aGlzLmZhaWx1cmVSZXN1bHRzLmxlbmd0aCA9PT0gdGhpcy5wcm9taXNlcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMudHJpZ2dlclN1Y2Nlc3NlcygpO1xuICAgICAgaWYgKHRoaXMuaGFzRmFpbHVyZXMoKSkge1xuICAgICAgICB0aGlzLnRyaWdnZXJGYWlsdXJlcygpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgdHJpZ2dlckZhaWx1cmVzKCkge1xuICAgIHRoaXMuZmFpbHVyZUhhbmRsZXJzLmZvckVhY2goaGFuZGxlciA9PiB7XG4gICAgICBoYW5kbGVyKHRoaXMuZmFpbHVyZVJlc3VsdHMpO1xuICAgIH0pO1xuICAgIHRoaXMucmVqZWN0b3JzLmZvckVhY2gocmVqZWN0b3IgPT4gcmVqZWN0b3IodGhpcy5mYWlsdXJlUmVzdWx0cykpO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmlnZ2VyU3VjY2Vzc2VzKCkge1xuICAgIHRoaXMubWFwcGVycy5mb3JFYWNoKG1hcHBlciA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBtYXBwZWQgPSBtYXBwZXIodGhpcy5zdWNjZXNzUmVzdWx0cyk7XG4gICAgICAgIF8uZWFjaCh0aGlzLnJlc29sdmVycywgcmVzb2x2ZXIgPT4gcmVzb2x2ZXIobWFwcGVkKSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHRoaXMucmVqZWN0b3JzLmZvckVhY2gocmVqZWN0b3IgPT4gcmVqZWN0b3IoZSkpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHRoZW48VT4obWFwcGVyOiBCYXRjaE1hcHBlcjxULCBVPik6IFByb21pc2UuSVRoZW5hYmxlPFU+IHtcbiAgICB0aGlzLm1hcHBlcnMucHVzaChtYXBwZXIpO1xuICAgIHZhciBydmFsID0gbmV3IFByb21pc2U8VT4oKFxuICAgICAgcmVzb2x2ZTogKHZhbDogVSkgPT4gdm9pZCxcbiAgICAgIHJlamVjdDogKGVycjogYW55KSA9PiB2b2lkXG4gICAgKSA9PiB7XG4gICAgICB0aGlzLnJlc29sdmVycy5wdXNoKHJlc29sdmUpO1xuICAgICAgdGhpcy5yZWplY3RvcnMucHVzaChyZWplY3QpO1xuICAgIH0pO1xuICAgIHRoaXMubmV4dFByb21pc2VzLnB1c2gocnZhbCk7XG4gICAgdGhpcy5jaGVja0lmVGhlcmVJc1BlbmRpbmdQcm9taXNlKCk7XG4gICAgcmV0dXJuIHJ2YWw7XG4gIH1cblxuICBwdWJsaWMgY2F0Y2gob25SZWplY3RlZDogKGVycm9yOiBhbnkpID0+IElUaGVuYWJsZTxUPiB8IFQpOiBQcm9taXNlQ29tcGxldGlvbjxUPiB7XG4gICAgdGhpcy5mYWlsdXJlSGFuZGxlcnMucHVzaChvblJlamVjdGVkKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBoYXNGYWlsdXJlcygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5mYWlsdXJlUmVzdWx0cy5sZW5ndGggPiAwO1xuICB9XG5cblxufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
