define(["require", "exports", "./model/ProjectModel", "./model/ProgressIndicator"], function (require, exports, ProjectModel_1, ProgressIndicator_1) {
    function normalizePackageJsonUrl(inputUrl) {
        var pathname = null;
        if (inputUrl.indexOf("git@github.com") === 0) {
            pathname = "/" + inputUrl.substring(inputUrl.indexOf(":") + 1, inputUrl.length - 4);
        }
        else {
            var parser = document.createElement('a');
            parser.href = inputUrl;
            pathname = parser.pathname;
            if (parser.host === "raw.githubusercontent.com") {
                return inputUrl;
            }
            if (parser.host === "github.com") {
                var pathSegments = pathname.split("/");
                if (pathSegments.length >= 4 && pathSegments[3] == "blob") {
                    pathname = "/" + pathSegments[1] + "/" + pathSegments[2];
                }
            }
            else {
                return inputUrl;
            }
        }
        if (pathname.substring(pathname.length - 4) === ".git") {
            pathname = pathname.substring(0, pathname.length - 4);
        }
        if (pathname.charAt(pathname.length - 1) == "/") {
            pathname = pathname.substring(0, pathname.length - 1);
        }
        if (pathname == null) {
            return null;
        }
        return "https://raw.githubusercontent.com" + pathname + "/master/package.json";
    }
    exports.normalizePackageJsonUrl = normalizePackageJsonUrl;
    var AppInitProcess = (function () {
        function AppInitProcess(rawPackageJson, url) {
            this.rawPackageJson = rawPackageJson;
            this.url = url;
            this.initListeners = [];
        }
        AppInitProcess.startWithUrl = function (url) {
            return new AppInitProcess(null, normalizePackageJsonUrl(url));
        };
        AppInitProcess.startWithPackageJson = function (rawPackageJson) {
            return new AppInitProcess(rawPackageJson, null);
        };
        AppInitProcess.prototype.parsePackageJson = function (success, reject, rawPackageJson) {
            try {
                if (_.isString(rawPackageJson)) {
                    success(JSON.parse(rawPackageJson));
                }
                else {
                    success(rawPackageJson);
                }
            }
            catch (e) {
                this.onFailure("Syntax error: this is not a valid package.json file");
                reject(rawPackageJson);
            }
        };
        AppInitProcess.prototype.obtainPackageJson = function () {
            var _this = this;
            if (this.rawPackageJson == null) {
                var success, reject;
                var rval = new Promise(function (succ, rej) {
                    success = succ;
                    reject = rej;
                });
                $.getJSON(this.url).then(function (rawPackageJson) {
                    _this.parsePackageJson(success, reject, rawPackageJson);
                }).fail(reject);
                return rval;
            }
            else {
                return new Promise(function (success, reject) {
                    _this.parsePackageJson(success, reject, _this.rawPackageJson);
                });
            }
        };
        AppInitProcess.prototype.init = function () {
            var _this = this;
            var resolver = function (success, reject) {
                _this.onSuccess = success;
                _this.onFailure = reject;
            };
            var rval = new Promise(resolver);
            this.obtainPackageJson().then(function (packageJson) {
                if (!(packageJson.name && packageJson.version)) {
                    _this.onFailure("Please provide a package.json with a name and a version");
                    return;
                }
                var hasDeps = _.isObject(packageJson.dependencies) && !_.isEmpty(packageJson.dependencies);
                var hasDevDeps = _.isObject(packageJson.devDependencies) && !_.isEmpty(packageJson.devDependencies);
                if (!(hasDeps || hasDevDeps)) {
                    _this.onFailure("Please provide a package.json with at least one dependency");
                    return;
                }
                var depCount = _.size(packageJson.dependencies) + _.size(packageJson.devDependencies);
                var progress = new ProgressIndicator_1.ProgressIndicatorImpl(depCount, 5);
                _this.initListeners.forEach(function (listener) { return listener.npmFetchStarted(progress); });
                ProjectModel_1.default.createForPackageJson(packageJson, progress).then(_this.projectLoaded.bind(_this));
            }).catch(function (e) { return console.log(e); });
            return rval;
        };
        AppInitProcess.prototype.projectLoaded = function (project) {
            this.initListeners.forEach(function (listener) { return listener.npmFetchFinished(project); });
        };
        AppInitProcess.prototype.addInitListener = function (listener) {
            this.initListeners.push(listener);
            return this;
        };
        return AppInitProcess;
    })();
    exports.AppInitProcess = AppInitProcess;
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4vQXBwSW5pdFByb2Nlc3MudHMiXSwibmFtZXMiOlsibm9ybWFsaXplUGFja2FnZUpzb25VcmwiLCJBcHBJbml0UHJvY2VzcyIsIkFwcEluaXRQcm9jZXNzLmNvbnN0cnVjdG9yIiwiQXBwSW5pdFByb2Nlc3Muc3RhcnRXaXRoVXJsIiwiQXBwSW5pdFByb2Nlc3Muc3RhcnRXaXRoUGFja2FnZUpzb24iLCJBcHBJbml0UHJvY2Vzcy5wYXJzZVBhY2thZ2VKc29uIiwiQXBwSW5pdFByb2Nlc3Mub2J0YWluUGFja2FnZUpzb24iLCJBcHBJbml0UHJvY2Vzcy5pbml0IiwiQXBwSW5pdFByb2Nlc3MucHJvamVjdExvYWRlZCIsIkFwcEluaXRQcm9jZXNzLmFkZEluaXRMaXN0ZW5lciJdLCJtYXBwaW5ncyI6IjtJQUlBLGlDQUF3QyxRQUFnQjtRQUN0REEsSUFBSUEsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDcEJBLEVBQUVBLENBQUNBLENBQUNBLFFBQVFBLENBQUNBLE9BQU9BLENBQUNBLGdCQUFnQkEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDN0NBLFFBQVFBLEdBQUdBLEdBQUdBLEdBQUdBLFFBQVFBLENBQUNBLFNBQVNBLENBQUNBLFFBQVFBLENBQUNBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLFFBQVFBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1FBQ3RGQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNOQSxJQUFJQSxNQUFNQSxHQUFHQSxRQUFRQSxDQUFDQSxhQUFhQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUN6Q0EsTUFBTUEsQ0FBQ0EsSUFBSUEsR0FBR0EsUUFBUUEsQ0FBQ0E7WUFDdkJBLFFBQVFBLEdBQUdBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBO1lBQzNCQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxL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YUFBYUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBQUEsUUFBUUEsSUFBSUEsT0FBQUEsUUFBUUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxPQUFPQSxDQUFDQSxFQUFsQ0EsQ0FBa0NBLENBQUNBLENBQUNBO1FBQzdFQSxDQUFDQTtRQUVNUCx3Q0FBZUEsR0FBdEJBLFVBQXVCQSxRQUFzQkE7WUFDM0NRLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO1lBQ2xDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtRQUNkQSxDQUFDQTtRQUVIUixxQkFBQ0E7SUFBREEsQ0F0RkEsQUFzRkNBLElBQUE7SUF0Rlksc0JBQWMsaUJBc0YxQixDQUFBIiwiZmlsZSI6Im1haW4vQXBwSW5pdFByb2Nlc3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgSVRoZW5hYmxlID0gUHJvbWlzZS5JVGhlbmFibGU7XG5pbXBvcnQgUHJvamVjdE1vZGVsIGZyb20gXCIuL21vZGVsL1Byb2plY3RNb2RlbFwiO1xuaW1wb3J0IHtQcm9ncmVzc0luZGljYXRvciwgUHJvZ3Jlc3NJbmRpY2F0b3JJbXBsfSBmcm9tIFwiLi9tb2RlbC9Qcm9ncmVzc0luZGljYXRvclwiO1xuXG5leHBvcnQgZnVuY3Rpb24gbm9ybWFsaXplUGFja2FnZUpzb25VcmwoaW5wdXRVcmw6IHN0cmluZykge1xuICB2YXIgcGF0aG5hbWUgPSBudWxsO1xuICBpZiAoaW5wdXRVcmwuaW5kZXhPZihcImdpdEBnaXRodWIuY29tXCIpID09PSAwKSB7XG4gICAgcGF0aG5hbWUgPSBcIi9cIiArIGlucHV0VXJsLnN1YnN0cmluZyhpbnB1dFVybC5pbmRleE9mKFwiOlwiKSArIDEsIGlucHV0VXJsLmxlbmd0aCAtIDQpO1xuICB9IGVsc2Uge1xuICAgIHZhciBwYXJzZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XG4gICAgcGFyc2VyLmhyZWYgPSBpbnB1dFVybDtcbiAgICBwYXRobmFtZSA9IHBhcnNlci5wYXRobmFtZTtcbiAgICBpZiAocGFyc2VyLmhvc3QgPT09IFwicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbVwiKSB7XG4gICAgICByZXR1cm4gaW5wdXRVcmw7XG4gICAgfVxuXG4gICAgaWYgKHBhcnNlci5ob3N0ID09PSBcImdpdGh1Yi5jb21cIikge1xuICAgICAgY29uc3QgcGF0aFNlZ21lbnRzID0gcGF0aG5hbWUuc3BsaXQoXCIvXCIpO1xuICAgICAgaWYgKHBhdGhTZWdtZW50cy5sZW5ndGggPj0gNCAmJiBwYXRoU2VnbWVudHNbM10gPT0gXCJibG9iXCIpIHtcbiAgICAgICAgcGF0aG5hbWUgPSBcIi9cIiArIHBhdGhTZWdtZW50c1sxXSArIFwiL1wiICsgcGF0aFNlZ21lbnRzWzJdO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gaW5wdXRVcmw7XG4gICAgfVxuICB9XG4gIGlmIChwYXRobmFtZS5zdWJzdHJpbmcocGF0aG5hbWUubGVuZ3RoIC0gNCkgPT09IFwiLmdpdFwiKSB7XG4gICAgcGF0aG5hbWUgPSBwYXRobmFtZS5zdWJzdHJpbmcoMCwgcGF0aG5hbWUubGVuZ3RoIC0gNCk7XG4gIH1cbiAgaWYgKHBhdGhuYW1lLmNoYXJBdChwYXRobmFtZS5sZW5ndGggLSAxKSA9PSBcIi9cIikge1xuICAgIHBhdGhuYW1lID0gcGF0aG5hbWUuc3Vic3RyaW5nKDAsIHBhdGhuYW1lLmxlbmd0aCAtIDEpO1xuICB9XG4gIGlmIChwYXRobmFtZSA9PSBudWxsKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgcmV0dXJuIFwiaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tXCIgKyBwYXRobmFtZSArIFwiL21hc3Rlci9wYWNrYWdlLmpzb25cIjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJbml0TGlzdGVuZXIge1xuXG4gIG5wbUZldGNoU3RhcnRlZChwcm9ncmVzczogUHJvZ3Jlc3NJbmRpY2F0b3IpOiB2b2lkO1xuXG4gIG5wbUZldGNoRmluaXNoZWQocHJvamVjdDogUHJvamVjdE1vZGVsKTogdm9pZDtcblxufVxuXG5cbmV4cG9ydCBjbGFzcyBBcHBJbml0UHJvY2VzcyB7XG5cbiAgc3RhdGljIHN0YXJ0V2l0aFVybCh1cmw6IHN0cmluZyk6IEFwcEluaXRQcm9jZXNzIHtcbiAgICByZXR1cm4gbmV3IEFwcEluaXRQcm9jZXNzKG51bGwsIG5vcm1hbGl6ZVBhY2thZ2VKc29uVXJsKHVybCkpO1xuICB9XG5cbiAgc3RhdGljIHN0YXJ0V2l0aFBhY2thZ2VKc29uKHJhd1BhY2thZ2VKc29uOiBzdHJpbmcpOiBBcHBJbml0UHJvY2VzcyB7XG4gICAgcmV0dXJuIG5ldyBBcHBJbml0UHJvY2VzcyhyYXdQYWNrYWdlSnNvbiwgbnVsbCk7XG4gIH1cblxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmF3UGFja2FnZUpzb246IHN0cmluZywgcHJpdmF0ZSB1cmw6IHN0cmluZykge1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0TGlzdGVuZXJzOiBJbml0TGlzdGVuZXJbXSA9IFtdO1xuXG4gIHByaXZhdGUgb25TdWNjZXNzOiAocHJvamVjdDogUHJvamVjdE1vZGVsKSA9PiB2b2lkO1xuXG4gIHByaXZhdGUgcGFyc2VQYWNrYWdlSnNvbihzdWNjZXNzOiAoYW55KSA9PiB2b2lkLCByZWplY3Q6IChhbnkpID0+IHZvaWQsIHJhd1BhY2thZ2VKc29uOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0cnkge1xuICAgICAgaWYgKF8uaXNTdHJpbmcocmF3UGFja2FnZUpzb24pKSB7XG4gICAgICAgIHN1Y2Nlc3MoSlNPTi5wYXJzZShyYXdQYWNrYWdlSnNvbikpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3VjY2VzcyhyYXdQYWNrYWdlSnNvbik7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhpcy5vbkZhaWx1cmUoXCJTeW50YXggZXJyb3I6IHRoaXMgaXMgbm90IGEgdmFsaWQgcGFja2FnZS5qc29uIGZpbGVcIik7XG4gICAgICByZWplY3QocmF3UGFja2FnZUpzb24pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgb2J0YWluUGFja2FnZUpzb24oKTogSVRoZW5hYmxlPGFueT4ge1xuICAgIGlmICh0aGlzLnJhd1BhY2thZ2VKc29uID09IG51bGwpIHtcbiAgICAgIGxldCBzdWNjZXNzLCByZWplY3Q7XG4gICAgICBjb25zdCBydmFsID0gbmV3IFByb21pc2UoKHN1Y2MsIHJlaikgPT4ge1xuICAgICAgICBzdWNjZXNzID0gc3VjYztcbiAgICAgICAgcmVqZWN0ID0gcmVqO1xuICAgICAgfSk7XG4gICAgICAkLmdldEpTT04odGhpcy51cmwpLnRoZW4ocmF3UGFja2FnZUpzb24gPT4ge1xuICAgICAgICB0aGlzLnBhcnNlUGFja2FnZUpzb24oc3VjY2VzcywgcmVqZWN0LCByYXdQYWNrYWdlSnNvbik7XG4gICAgICB9KS5mYWlsKHJlamVjdCk7XG4gICAgICByZXR1cm4gcnZhbDtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChzdWNjZXNzLCByZWplY3QpID0+IHtcbiAgICAgICAgdGhpcy5wYXJzZVBhY2thZ2VKc29uKHN1Y2Nlc3MsIHJlamVjdCwgdGhpcy5yYXdQYWNrYWdlSnNvbik7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uRmFpbHVyZTogKHJlYXNvbjogYW55KSA9PiB2b2lkO1xuXG5cbiAgaW5pdCgpOiBJVGhlbmFibGU8UHJvamVjdE1vZGVsPiB7XG4gICAgY29uc3QgcmVzb2x2ZXIgPSAoc3VjY2VzczogKHZhbHVlOiBQcm9qZWN0TW9kZWwpID0+IHZvaWQsIHJlamVjdDogKHJlYXNvbjogYW55KSA9PiB2b2lkKSA9PiB7XG4gICAgICB0aGlzLm9uU3VjY2VzcyA9IHN1Y2Nlc3M7XG4gICAgICB0aGlzLm9uRmFpbHVyZSA9IHJlamVjdDtcbiAgICB9O1xuICAgIGNvbnN0IHJ2YWwgPSBuZXcgUHJvbWlzZShyZXNvbHZlcik7XG4gICAgdGhpcy5vYnRhaW5QYWNrYWdlSnNvbigpLnRoZW4ocGFja2FnZUpzb24gPT4ge1xuICAgICAgaWYgKCEocGFja2FnZUpzb24ubmFtZSAmJiBwYWNrYWdlSnNvbi52ZXJzaW9uKSkge1xuICAgICAgICB0aGlzLm9uRmFpbHVyZShcIlBsZWFzZSBwcm92aWRlIGEgcGFja2FnZS5qc29uIHdpdGggYSBuYW1lIGFuZCBhIHZlcnNpb25cIik7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGhhc0RlcHMgPSBfLmlzT2JqZWN0KHBhY2thZ2VKc29uLmRlcGVuZGVuY2llcykgJiYgIV8uaXNFbXB0eShwYWNrYWdlSnNvbi5kZXBlbmRlbmNpZXMpO1xuICAgICAgY29uc3QgaGFzRGV2RGVwcyA9IF8uaXNPYmplY3QocGFja2FnZUpzb24uZGV2RGVwZW5kZW5jaWVzKSAmJiAhXy5pc0VtcHR5KHBhY2thZ2VKc29uLmRldkRlcGVuZGVuY2llcyk7XG4gICAgICBpZiAoIShoYXNEZXBzIHx8IGhhc0RldkRlcHMpKSB7XG4gICAgICAgIHRoaXMub25GYWlsdXJlKFwiUGxlYXNlIHByb3ZpZGUgYSBwYWNrYWdlLmpzb24gd2l0aCBhdCBsZWFzdCBvbmUgZGVwZW5kZW5jeVwiKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgY29uc3QgZGVwQ291bnQgPSBfLnNpemUocGFja2FnZUpzb24uZGVwZW5kZW5jaWVzKSArIF8uc2l6ZShwYWNrYWdlSnNvbi5kZXZEZXBlbmRlbmNpZXMpO1xuICAgICAgY29uc3QgcHJvZ3Jlc3MgPSBuZXcgUHJvZ3Jlc3NJbmRpY2F0b3JJbXBsKGRlcENvdW50LCA1KTtcbiAgICAgIHRoaXMuaW5pdExpc3RlbmVycy5mb3JFYWNoKGxpc3RlbmVyID0+IGxpc3RlbmVyLm5wbUZldGNoU3RhcnRlZChwcm9ncmVzcykpO1xuICAgICAgUHJvamVjdE1vZGVsLmNyZWF0ZUZvclBhY2thZ2VKc29uKHBhY2thZ2VKc29uLCBwcm9ncmVzcykudGhlbih0aGlzLnByb2plY3RMb2FkZWQuYmluZCh0aGlzKSk7XG4gICAgfSkuY2F0Y2goZSA9PiBjb25zb2xlLmxvZyhlKSk7XG4gICAgcmV0dXJuIHJ2YWw7XG4gIH1cblxuICBwcml2YXRlIHByb2plY3RMb2FkZWQocHJvamVjdDogUHJvamVjdE1vZGVsKSB7XG4gICAgdGhpcy5pbml0TGlzdGVuZXJzLmZvckVhY2gobGlzdGVuZXIgPT4gbGlzdGVuZXIubnBtRmV0Y2hGaW5pc2hlZChwcm9qZWN0KSk7XG4gIH1cblxuICBwdWJsaWMgYWRkSW5pdExpc3RlbmVyKGxpc3RlbmVyOiBJbml0TGlzdGVuZXIpOiBBcHBJbml0UHJvY2VzcyB7XG4gICAgdGhpcy5pbml0TGlzdGVuZXJzLnB1c2gobGlzdGVuZXIpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbn1cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
